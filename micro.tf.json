{
    "data": {
        "aws_route53_zone": {
            "micro_domain_zone": {
                "name": "chopshop-test.net"
            }
        },
        "aws_region": {
            "micro_docker_auth": {}
        },
        "aws_caller_identity": {
            "micro_docker_auth": {}
        },
        "aws_ecr_authorization_token": {
            "micro_docker_auth": {}
        },
        "external": {
            "micro_docker_archive_prepare": {
                "program": [
                    "${(substr(pathexpand(\"~\"), 0, 1) == \"/\") ? \"python3\" : \"python.exe\"}",
                    "${path.root}/src/utils/package.py",
                    "prepare"
                ],
                "query": {
                    "paths": "{\"module\":\"${path.module}\",\"root\":\"${path.root}\",\"cwd\":\"${path.cwd}\"}",
                    "docker": "{\"docker_pip_cache\":null,\"docker_build_root\":\"./src/docker\",\"docker_file\":\"Dockerfile\",\"docker_image\":\"${data.aws_caller_identity.micro_docker_auth.account_id}.dkr.ecr.${data.aws_region.micro_docker_auth.name}.amazonaws.com/${resource.aws_ecr_repository.micro_repo_ecr_repo.name}:throwaway-test-123\",\"with_ssh_agent\":false,\"docker_additional_options\":[],\"docker_entrypoint\":null}",
                    "artifacts_dir": "builds",
                    "runtime": "python3.11",
                    "source_path": "./src/docker",
                    "hash_extra": "somestring",
                    "hash_extra_paths": "[]",
                    "recreate_missing_package": true
                }
            }
        },
        "aws_iam_policy_document": {
            "micro_ms1_lambda_creds": {
                "statement": {
                    "effect": "Allow",
                    "actions": [
                        "sts:AssumeRole"
                    ],
                    "principals": {
                        "identifiers": [
                            "lambda.amazonaws.com",
                            "apigateway.amazonaws.com"
                        ],
                        "type": "Service"
                    }
                }
            },
            "micro_ms1_bucket_access_creds": {
                "statement": [
                    {
                        "principals": {
                            "identifiers": [
                                "${resource.aws_iam_role.micro_ms1_lambda_role.arn}"
                            ],
                            "type": "AWS"
                        },
                        "effect": "Allow",
                        "actions": [
                            "s3:AbortMultipartUpload",
                            "s3:ListMultipartUploadParts",
                            "s3:ListBucketMultipartUploads",
                            "s3:PutObject",
                            "s3:GetObject",
                            "s3:DeleteObject"
                        ],
                        "resources": [
                            "arn:aws:s3:::${resource.aws_s3_bucket.micro_ms1_bucket.bucket}",
                            "arn:aws:s3:::${resource.aws_s3_bucket.micro_ms1_bucket.bucket}/*"
                        ]
                    }
                ]
            },
            "micro_ms1_lambda_access_creds": {
                "statement": [
                    {
                        "effect": "Allow",
                        "actions": [
                            "s3:AbortMultipartUpload",
                            "s3:ListMultipartUploadParts",
                            "s3:ListBucketMultipartUploads",
                            "s3:PutObject",
                            "s3:GetObject",
                            "s3:DeleteObject"
                        ],
                        "resources": [
                            "arn:aws:s3:::${resource.aws_s3_bucket.micro_ms1_bucket.bucket}",
                            "arn:aws:s3:::${resource.aws_s3_bucket.micro_ms1_bucket.bucket}/*"
                        ]
                    },
                    {
                        "effect": "Allow",
                        "actions": [
                            "sns:Publish",
                            "sns:Subscribe"
                        ],
                        "resources": [
                            "${resource.aws_sns_topic.micro_topic_sns.arn}"
                        ]
                    },
                    {
                        "effect": "Allow",
                        "actions": [
                            "logs:CreateLogGroup",
                            "logs:CreateLogStream",
                            "logs:PutLogEvents"
                        ],
                        "resources": [
                            "${resource.aws_cloudwatch_log_group.micro_ms1_cloudwatch.arn}:*",
                            "${resource.aws_cloudwatch_log_group.micro_ms1_cloudwatch.arn}:*:*"
                        ]
                    }
                ]
            }
        }
    },
    "resource": {
        "aws_sns_topic": {
            "micro_topic_sns": {
                "name": "-topic",
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_ecr_repository": {
            "micro_repo_ecr_repo": {
                "force_delete": true,
                "name": "throwaway-test-123/test1",
                "image_tag_mutability": "MUTABLE",
                "image_scanning_configuration": {
                    "scan_on_push": false
                },
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_ecr_lifecycle_policy": {
            "micro_repo_lifecycle_policy": {
                "repository": "throwaway-test-123/test1",
                "policy": "{\"rules\":[{\"rulePriority\":1,\"description\":\"Keep only the last 2 images\",\"selection\":{\"tagStatus\":\"any\",\"countType\":\"imageCountMoreThan\",\"countNumber\":2},\"action\":{\"type\":\"expire\"}}]}"
            }
        },
        "local_file": {
            "micro_docker_archive_plan": {
                "content": "${data.external.micro_docker_archive_prepare.result.build_plan}",
                "filename": "${data.external.micro_docker_archive_prepare.result.build_plan_filename}",
                "directory_permission": "0755",
                "file_permission": "0644"
            }
        },
        "null_resource": {
            "micro_docker_archive": {
                "triggers": {
                    "filename": "${data.external.micro_docker_archive_prepare.result.filename}",
                    "timestamp": "${data.external.micro_docker_archive_prepare.result.timestamp}"
                },
                "provisioner": {
                    "local-exec": {
                        "interpreter": [
                            "python",
                            "${path.root}/src/utils/package.py",
                            "build",
                            "--timestamp",
                            "${data.external.micro_docker_archive_prepare.result.timestamp}"
                        ],
                        "command": "${data.external.micro_docker_archive_prepare.result.build_plan_filename}"
                    }
                }
            }
        },
        "docker_image": {
            "micro_docker_docker_img": {
                "name": "${data.aws_caller_identity.micro_docker_auth.account_id}.dkr.ecr.${data.aws_region.micro_docker_auth.name}.amazonaws.com/${resource.aws_ecr_repository.micro_repo_ecr_repo.name}:throwaway-test-123",
                "build": {
                    "dockerfile": "Dockerfile",
                    "context": "./src/docker",
                    "platform": "linux/amd64"
                }
            }
        },
        "docker_registry_image": {
            "micro_docker_registry_img": {
                "name": "${resource.docker_image.micro_docker_docker_img.name}",
                "keep_remotely": false
            }
        },
        "aws_iam_role": {
            "micro_ms1_lambda_role": {
                "name": "throwaway-test-123-role",
                "assume_role_policy": "${data.aws_iam_policy_document.micro_ms1_lambda_creds.json}",
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_s3_bucket": {
            "micro_ms1_bucket": {
                "bucket": "throwaway-test-123-bucket",
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_s3_bucket_cors_configuration": {
            "micro_ms1_bucket_cors": {
                "bucket": "${resource.aws_s3_bucket.micro_ms1_bucket.bucket}",
                "cors_rule": {
                    "allowed_methods": [
                        "POST",
                        "GET",
                        "HEAD",
                        "DELETE",
                        "PUT"
                    ],
                    "allowed_origins": [
                        "*"
                    ],
                    "allowed_headers": [
                        "*"
                    ],
                    "expose_headers": [
                        "ETag"
                    ],
                    "max_age_seconds": 3000
                }
            }
        },
        "aws_s3_bucket_policy": {
            "micro_ms1_bucket_policy": {
                "bucket": "${resource.aws_s3_bucket.micro_ms1_bucket.bucket}",
                "policy": "${data.aws_iam_policy_document.micro_ms1_bucket_access_creds.json}"
            }
        },
        "aws_cloudwatch_log_group": {
            "micro_ms1_cloudwatch": {
                "name": "/aws/lambda/throwaway-test-123-log-group",
                "retention_in_days": 7,
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_iam_policy": {
            "micro_ms1_lambda_policy": {
                "name": "throwaway-test-123-policy-policy",
                "policy": "${data.aws_iam_policy_document.micro_ms1_lambda_access_creds.json}",
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_iam_role_policy_attachment": {
            "micro_ms1_lambda_policy_attachment": {
                "role": "${resource.aws_iam_role.micro_ms1_lambda_role.name}",
                "policy_arn": "${resource.aws_iam_policy.micro_ms1_lambda_policy.arn}"
            }
        },
        "aws_lambda_function": {
            "micro_ms1_lambda": {
                "runtime": "python3.8",
                "handler": "handler.handler",
                "package_type": "Image",
                "function_name": "lambda-throwaway-test-123",
                "role": "${resource.aws_iam_role.micro_ms1_lambda_role.arn}",
                "environment": {
                    "variables": {
                        "S3_BUCKET_NAME": "${resource.aws_s3_bucket.micro_ms1_bucket.bucket}",
                        "SNS_TOPIC_ARN": "${resource.aws_sns_topic.micro_topic_sns.arn}",
                        "SNS_MESSAGE_ATTRS": "{\"type\":{\"DataType\":\"String\",\"StringValue\":\"audio\"}}"
                    }
                },
                "image_uri": "${resource.docker_registry_image.micro_docker_registry_img.name}",
                "architectures": [
                    "x86_64"
                ],
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_lambda_permission": {
            "micro_ms1_sns_invoke_cred": {
                "statement_id": "AllowExecutionFromSNS",
                "action": "lambda:InvokeFunction",
                "function_name": "${resource.aws_lambda_function.micro_ms1_lambda.function_name}",
                "principal": "sns.amazonaws.com",
                "source_arn": "${resource.aws_sns_topic.micro_topic_sns.arn}"
            },
            "micro_api_invoker_test1_ANY": {
                "statement_id": "AllowExecutionFromAPIGateway",
                "action": "lambda:InvokeFunction",
                "function_name": "${resource.aws_lambda_function.micro_ms1_lambda.function_name}",
                "principal": "apigateway.amazonaws.com",
                "source_arn": "${resource.aws_apigatewayv2_api.micro_api_apigw_test1.execution_arn}"
            }
        },
        "aws_sns_topic_subscription": {
            "micro_ms1_subscription": {
                "topic_arn": "${resource.aws_sns_topic.micro_topic_sns.arn}",
                "protocol": "lambda",
                "endpoint": "${resource.aws_lambda_function.micro_ms1_lambda.arn}",
                "filter_policy": "{\"type\":[\"video\"]}",
                "filter_policy_scope": "MessageAttributes"
            }
        },
        "aws_acm_certificate": {
            "micro_api_cert_test1": {
                "domain_name": "test1.chopshop-test.net",
                "validation_method": "DNS",
                "lifecycle": {
                    "create_before_destroy": true
                },
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_acm_certificate_validation": {
            "micro_api_validation_test1": {
                "certificate_arn": "${resource.aws_acm_certificate.micro_api_cert_test1.arn}",
                "validation_record_fqdns": [
                    "${resource.aws_route53_record.micro_api_record_valid_test1.fqdn}"
                ]
            }
        },
        "aws_apigatewayv2_domain_name": {
            "micro_api_domain_test1": {
                "domain_name": "test1.chopshop-test.net",
                "domain_name_configuration": [
                    {
                        "certificate_arn": "${resource.aws_acm_certificate_validation.micro_api_validation_test1.certificate_arn}",
                        "endpoint_type": "REGIONAL",
                        "security_policy": "TLS_1_2"
                    }
                ],
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_route53_record": {
            "micro_api_record_test1": {
                "name": "test1.chopshop-test.net",
                "type": "A",
                "zone_id": "${data.aws_route53_zone.micro_domain_zone.zone_id}",
                "allow_overwrite": true,
                "alias": {
                    "name": "${resource.aws_apigatewayv2_domain_name.micro_api_domain_test1.domain_name_configuration[0].target_domain_name}",
                    "zone_id": "${resource.aws_apigatewayv2_domain_name.micro_api_domain_test1.domain_name_configuration[0].hosted_zone_id}",
                    "evaluate_target_health": false
                }
            },
            "micro_api_record_valid_test1": {
                "name": "${one(resource.aws_acm_certificate.micro_api_cert_test1.domain_validation_options).resource_record_name}",
                "type": "${one(resource.aws_acm_certificate.micro_api_cert_test1.domain_validation_options).resource_record_type}",
                "zone_id": "${data.aws_route53_zone.micro_domain_zone.zone_id}",
                "allow_overwrite": true,
                "records": [
                    "${one(resource.aws_acm_certificate.micro_api_cert_test1.domain_validation_options).resource_record_value}"
                ],
                "ttl": 60
            }
        },
        "aws_apigatewayv2_api": {
            "micro_api_apigw_test1": {
                "name": "test1.chopshop-test.net",
                "description": "api for test1.chopshop-test.net",
                "disable_execute_api_endpoint": false,
                "protocol_type": "HTTP",
                "cors_configuration": {
                    "allow_headers": [
                        "content-type",
                        "x-amz-date",
                        "authorization",
                        "x-api-key",
                        "x-amz-security-token",
                        "x-amz-user-agent"
                    ],
                    "allow_methods": [
                        "*"
                    ],
                    "allow_origins": [
                        "*"
                    ],
                    "max_age": 300
                },
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_apigatewayv2_stage": {
            "micro_api_stage_test1": {
                "api_id": "${resource.aws_apigatewayv2_api.micro_api_apigw_test1.id}",
                "name": "$default",
                "auto_deploy": true,
                "description": "stage $default API",
                "tags": {
                    "BroughtToYouBy": "@-0/micro",
                    "Moms": "Spaghetti"
                }
            }
        },
        "aws_apigatewayv2_integration": {
            "micro_api_integration_test1_ANY": {
                "api_id": "${resource.aws_apigatewayv2_api.micro_api_apigw_test1.id}",
                "integration_uri": "${resource.aws_lambda_function.micro_ms1_lambda.invoke_arn}",
                "integration_type": "AWS_PROXY",
                "integration_method": "POST",
                "connection_type": "INTERNET",
                "payload_format_version": "2.0",
                "timeout_milliseconds": 29000
            }
        },
        "aws_apigatewayv2_route": {
            "micro_api_route_test1_ANY": {
                "api_id": "${resource.aws_apigatewayv2_api.micro_api_apigw_test1.id}",
                "route_key": "ANY /",
                "target": "integrations/${resource.aws_apigatewayv2_integration.micro_api_integration_test1_ANY.id}"
            }
        }
    },
    "provider": [
        {
            "aws": {
                "region": "us-east-2",
                "profile": "chopshop"
            }
        },
        {
            "docker": {
                "registry_auth": {
                    "address": "${data.aws_caller_identity.micro_docker_auth.account_id}.dkr.ecr.${data.aws_region.micro_docker_auth.name}.amazonaws.com",
                    "username": "${data.aws_ecr_authorization_token.micro_docker_auth.user_name}",
                    "password": "${data.aws_ecr_authorization_token.micro_docker_auth.password}"
                }
            }
        }
    ],
    "terraform": {
        "required_providers": {
            "aws": {
                "source": "hashicorp/aws",
                "version": ">= 5.20"
            },
            "docker": {
                "source": "kreuzwerker/docker",
                "version": ">= 3.0"
            },
            "null": {
                "source": "hashicorp/null",
                "version": ">= 2.0"
            }
        }
    }
}